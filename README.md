# koa

A lightweight command-line companion for the University of Hawai'i KOA cluster. The tool focuses on one job: making it easy to sync code, pick an appropriate GPU, submit jobs, and monitor their life cycle from your local workstation.

---

## Highlights
- **Job submission pipeline** – copy a script, infer sensible defaults, and hand it to `sbatch` with a single command.
- **GPU heuristics** – inspect live availability and auto-select the best GPU type for the requested partition.
- **Workspace snapshots** – every submission bundles the exact repo state so jobs run with reproducible code and configs.
- **Run manifests** – each submission stores git state and relevant untracked files alongside the job results for reproducibility.
- **Global setup** – one-time `koa setup` configures usernames, roots, and preferred modules for every project.
- **Run catalog** – every submission is indexed locally so you can list, sync, and inspect historical runs.
- **Plain Python package** – small dependency footprint and no bundled training/evaluation code.

---

## Installation

```bash
# Recommended: pipx keeps koa isolated but available everywhere
pipx install --force git+https://github.com/YosubShin/koa.git

# Alternatively: per-user install (ensure ~/.local/bin is on PATH)
python3 -m pip install --user git+https://github.com/YosubShin/koa.git

# Development: editable install inside a throwaway venv
python3 -m venv .venv
source .venv/bin/activate
pip install --upgrade pip setuptools wheel
pip install -e .
```

The CLI installs the entry point `koa`.

---

## Configure access

1. Run `koa setup` (once per machine) to capture your KOA username, host, and the global workspace roots on KOA and locally. The global config lives at `~/.config/koa/config.yaml`.
2. Inside each repository, run `koa init` to generate a minimal `koa-config.yaml` plus helper scripts. Edit the file only if you want to change per-project preferences such as GPU ordering or additional `env_watch` files.
3. (Optional) Update `gpu_preferences` or `env_watch` in `koa-config.yaml` to tweak the defaults.

The CLI automatically discovers `koa-config.yaml` by walking up from the current working directory. Environment variables such as `KOA_USER`, `KOA_HOST`, `KOA_IDENTITY_FILE`, `KOA_REMOTE_ROOT`, `KOA_LOCAL_ROOT`, `KOA_DEFAULT_PARTITION`, `KOA_PYTHON_MODULE`, `KOA_CUDA_MODULE`, `KOA_ENV_WATCH`, and `KOA_PROXY_COMMAND` can override the saved configuration at runtime.

Example `koa-config.yaml` generated by `koa init`:

```yaml
project: my-awesome-project

gpu_preferences:
  partitions:
    kill-shared:
      - type: nvidia_h200
        count: 2
      - type: nvidia_h100
        count: 2

env_watch:
  - scripts/setup_env.sh
  - requirements.txt
  - pyproject.toml
```


---

## Everyday workflow

```bash
# 0. (First time) Configure your KOA defaults
koa setup --user $USER

# 0b. (Per project) Bootstrap a repo with config + scripts
koa init

# 1. Check connectivity and cluster health
koa check

# 2. Inspect GPU supply on the default partition
koa gpus
# or specify a queue explicitly
koa gpus --partition kill-shared

# 3. Submit a job script (auto GPU selection unless you pass --no-auto-gpu)
koa submit examples/slurm/basic_job.slurm --time 01:00:00
# every submission writes a repo snapshot + run metadata under <local results>/<job-id>/
  # run_metadata/ includes env_hashes.json for watched setup files

# 4. Monitor jobs and inspect runs
koa jobs
koa cancel <job-id>
koa logs <job-id> --follow
koa runs list
```

Every submitted job includes a `run_metadata/` folder under its results directory containing `manifest.json`, `git_head.txt`, `git_status.txt`, `env_hashes.json`, and any untracked files that were present locally when you launched the run.

---

## CLI reference

- `check` – run a quick SSH round-trip and display `sinfo` output.
- `setup` – configure global defaults (user, workspace roots, preferred modules).
- `init` – scaffold project config and helper scripts using global defaults.
- `jobs` – list your queued and running jobs via `squeue`.
- `submit` – copy a script and call `sbatch`; use `--sbatch-arg` for raw overrides.
- `cancel` – stop a job by ID with `scancel`.
- `logs` – stream or inspect a job's stdout/stderr in real time via `tail` (stored at `<remote results dir>/<job-id>/job.log` and `job.err`).
- `gpus` – show detected GPU types and recommend a `--gres` request using your configured preferences.
- `runs` – sync and inspect the local catalog of submitted jobs.
  - `koa runs list` shows recent submissions (most recent first).
  - `koa runs sync` updates Slurm status and downloads completed runs into the local mirror automatically.
  - `koa runs show <job-id>` prints the recorded metadata (git commit, env hashes, locations) for a single run.

Each command accepts `--config /path/to/config.yaml` if you need to swap between multiple KOA accounts.

---

## Directory layout

`koa setup` captures two roots:

- **Remote root** (e.g. `/mnt/lustre/koa/scratch/<user>/koa-cli`)
- **Local root** (e.g. `~/.koa-cli`)

For a project named `<project>`, the CLI derives:

```
Remote: <remote_root>/projects/<project>/jobs/<job-id>/{repo,results,run_metadata}
Local : <local_root>/projects/<project>/jobs/<job-id>/{repo,results,run_metadata}
```

- `repo/` contains the exact snapshot submitted with the job.
- `run_metadata/` holds manifests, git info, and environment hashes.
- `results/` is where your job writes outputs; `koa runs sync` copies this directory back to the local mirror automatically once the job completes.

---

## Sample SLURM script

Minimal examples live under `examples/slurm/`. Start from `basic_job.slurm` and adapt the resources, modules, and commands to your workload. The CLI sets `KOA_ML_RESULTS_ROOT` automatically so jobs can collect outputs in the directory that `koa runs sync` mirrors locally once they finish.

Running `koa init` also drops a project-specific `scripts/basic_job.slurm` and `scripts/setup_env.sh` that you can customise; they mirror the global defaults captured by `koa setup`. The default config watches files like `scripts/setup_env.sh`, `requirements.txt`, and `pyproject.toml`, so changing any of them automatically triggers a virtualenv rebuild on the next submission.

---

## Development

Install development tooling with:

```bash
pip install -e .[dev]
ruff check
pytest
```

Contributions are welcome via pull request.
